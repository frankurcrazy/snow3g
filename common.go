// Code adapted from ETSI / SAGE specification of the 3GPP Confidentiality and Integrity Algorithms UEA2 & UIA2.
// Document 2: SNOW 3G Specification. Version 1.1 from the 6th September 2006, annex 4.
// https://www.gsma.com/security/wp-content/uploads/2019/05/snow3gspec.pdf

package snow3g

type Direction uint32

const (
	KEY_UPLINK   = Direction(0x0)
	KEY_DOWNLINK = Direction(0x1)
)

var (
	mulalphaArray = [256]uint32{0, 3785346835, 1805072166, 2315843637, 3599199820, 924361055, 3171965290, 1552914041, 94887064, 3828880267,
		1848699838, 2410620077, 3542135508, 851410375, 3099035122, 1495812833, 182915481, 3950567050, 1634739903, 2163206572,
		3697311701, 1040167110, 3086436595, 1449691104, 255905025, 4007592466, 1691875879, 2236101940, 3653739341, 945319006,
		2991625323, 1406098296, 342303387, 4126731656, 2146440637, 2658130606, 3269479639, 595559364, 2843180017, 1223210210,
		297860611, 4032770320, 2052573477, 2613577270, 3343355983, 651714396, 2899355497, 1297049722, 511718146, 4280286225,
		1964442660, 2491992887, 3355925838, 697864797, 2744150632, 1108321659, 455602074, 4206370953, 1890638012, 2435782575,
		3449848278, 742346437, 2788669168, 1202223587, 684606623, 3377564556, 1129935801, 2730933418, 4266207955, 534177216,
		2514361845, 1950470886, 761894919, 3438696212, 1191096097, 2808176690, 4226741835, 443627864, 2423898477, 1910902398,
		573134086, 3283524117, 1237213728, 2820779315, 4105059146, 355595353, 2671316076, 2124858239, 663652766, 3323020941,
		1276755640, 2911269291, 4043958226, 278276289, 2594099444, 2063671271, 1017734660, 3711346967, 1463701794, 3064045105,
		3928885320, 196200283, 2176401262, 1613164669, 957266588, 3633411471, 1385795002, 3003531945, 4018787536, 236329923,
		2216616950, 1702964453, 911112093, 3620845710, 1574518971, 3158740904, 3771275729, 22468290, 2338205431, 1791091172,
		870951685, 3530974230, 1484692515, 3118551856, 3849241929, 82905690, 2398745199, 1868971388, 1345685655, 2980726660,
		1000521649, 3661459618, 2259871451, 1731013064, 3978678781, 213524206, 1435653135, 3020790556, 1040540457, 3751455802,
		2199206467, 1653273936, 3900837221, 152945270, 1523751182, 3142407709, 826650152, 3503972667, 2354444098, 1841969233,
		3888300132, 106762103, 1601521046, 3203041925, 887255728, 3581787555, 2314349530, 1752032457, 3798277372, 66769903,
		1146268172, 2781701407, 801479978, 3462025785, 2463482944, 1934232403, 4181914470, 417152117, 1106605716, 2691348871,
		711082418, 3422391969, 2540837080, 1995298763, 4242878462, 494592237, 1320532885, 2938795142, 623021235, 3300737952,
		2553468377, 2041387722, 4087735039, 305802732, 1259497229, 2861410334, 545607723, 3239747384, 2643790145, 2081080914,
		4127342183, 396226932, 2029767688, 2573468443, 325909294, 4076024893, 2927403588, 1340304727, 3320550754, 611605105,
		2103185552, 2630082435, 382412726, 4149536933, 2883288796, 1246015951, 3226225146, 567510761, 1914494353, 2474840706,
		428599991, 4162069924, 2761667549, 1157921998, 3473704187, 781405160, 2008744201, 2518994458, 472659503, 4256430396,
		2705092421, 1084465238, 3400226915, 724866928, 1822224019, 2365792640, 118217141, 3868464806, 3122364639, 1535397836,
		3515660281, 806582506, 1765487115, 2292514072, 44827949, 3811822142, 3216792647, 1579389780, 3559615329, 901031026,
		1719402250, 2279878681, 233621548, 3966961471, 2969342278, 1365466709, 3681265248, 989096307, 1675371410, 2185489537,
		139138228, 3923041191, 3042659806, 1422164685, 3737942776, 1062450667}

	divalphaArray = [256]uint32{0, 403652813, 807305267, 672252158, 1614588262, 2016668075, 1344416085, 1210935704, 3229154252, 3631725313,
		4033248255, 3899210546, 2688832170, 3091927655, 2421871257, 2287309396, 703618865, 838803452, 435085058, 31563727,
		1238169175, 1371780762, 2043836004, 1641887401, 3918046461, 4052214832, 3650495694, 3248055299, 2310278555, 2444971350,
		3114962344, 2711997797, 1380564578, 1246166703, 1649884753, 2052619932, 846534404, 712660937, 40605495, 442816506,
		2452702638, 2319320419, 2721039773, 3122693456, 4060998856, 3926043653, 3256052987, 3659279414, 2075779411, 1672913310,
		1269260640, 1403527597, 461719605, 59377912, 731629574, 865372363, 3149994655, 2748209746, 2346687148, 2479938145,
		3690836985, 3287479092, 3957535690, 4092359431, 2761086404, 3164443913, 2492225015, 2357400890, 3299769506, 3701554287,
		4105239697, 3971988572, 1693068808, 2095410885, 1425321531, 1291579126, 81168238, 484034467, 885524317, 751257488,
		2372045557, 2507000376, 3179023046, 2775796235, 3982369683, 4115751774, 3712000928, 3310347117, 1293578553, 1427452404,
		2097475850, 1695265223, 757520479, 891918482, 490231916, 87496865, 4141575078, 4006882155, 3334859669, 3737824088,
		2531771072, 2397602317, 2801353459, 3203793470, 916689002, 783077543, 113053785, 515002516, 1453275404, 1318091201,
		1719777599, 2123299314, 3744150679, 3341055066, 4013274276, 4147836009, 3205996017, 2803424572, 2399739330, 2533776655,
		525586267, 123506582, 793595752, 927076261, 2138007101, 1734354672, 1332864526, 1467918019, 3784114977, 4186063852,
		3516105490, 3382494175, 2175904327, 2579425930, 2981046900, 2845862585, 569768173, 972732448, 300644574, 165951507,
		1103712651, 1506152774, 1909969336, 1775800693, 3363658768, 3497139421, 4167293987, 3765214446, 2822894966, 2957948347,
		2556392773, 2152740232, 134588380, 269149969, 941303791, 538208034, 1748569786, 1882607223, 1478987401, 1076416068,
		3016015171, 2882272654, 2212117872, 2614459837, 3556250661, 3421983976, 3823539222, 4226405595, 1941718671, 1806894658,
		1134741180, 1538098801, 327217129, 193965860, 597585882, 999370519, 2587157106, 2184946367, 2854904385, 2988778124,
		4194847508, 3792112601, 3390491431, 3524889578, 1514936766, 1111710067, 1783798157, 1918753088, 980463832, 578809877,
		174993643, 308375590, 1159714533, 1561368104, 1963022038, 1829639707, 623083395, 1026309966, 356384688, 221429629,
		2238131497, 2640866788, 3044650266, 2910252503, 3847980111, 4250190978, 3578070140, 3444196529, 1827637716, 1960888601,
		1559300583, 1157515562, 215163058, 349986943, 1020108929, 616751180, 2895606296, 3029873365, 2626286123, 2223420134,
		3433814910, 3567557555, 4239743821, 3837401984, 391538823, 257501258, 659089588, 1061660793, 2003485153, 1868923180,
		1198801362, 1601896735, 3610153803, 3475100550, 3878687608, 4282340277, 3071425069, 2937944800, 2265758238, 2667838163,
		1051080630, 648640379, 246986629, 381155144, 1587191504, 1184226845, 1854152419, 1988845102, 4276014202, 3872492727,
		3468708937, 3603893380, 2665637148, 2263688657, 2935809327, 3069421026}
)

func mulx(v, c uint8) uint8 {
	if v&uint8(0x80) > 0 {
		return (v << 1) ^ c
	}

	return (v << 1)
}

func mulxpow(v uint8, i uint8, c uint8) uint8 {
	for i > 0 {
		v = mulx(v, c)
		i = i - 1
	}
	return v
}

func mulalpha(c uint8) uint32 {
	return mulalphaArray[c]
}

func divalpha(c uint8) uint32 {
	return divalphaArray[c]
}
